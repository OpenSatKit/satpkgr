#!/usr/bin/env ruby
require 'gli'
require 'satpkgr'

include GLI::App

program_desc 'Manage OpenSatKit applications'

version Satpkgr::VERSION

subcommand_option_handling :normal
arguments :strict

# desc 'Describe some switch here'
# switch [:s,:switch]

# desc 'Describe some flag here'
# default_value 'the default'
# arg_name 'The name of the argument'
# flag [:f,:flagname]

desc 'Initializes a new satpkgr project'
arg_name ''
skips_pre
command :init do |c|

  c.action do |global_options,options,args|

    SatPkgr::SatPkgr.initPackage(Dir.pwd)

  end
end

desc 'Installs an application from a github repository'
arg_name '<username/repository>'
command :install do |c|
  # c.desc 'Describe a switch to install'
  # c.switch :s

  # c.desc 'Describe a flag to install'
  # c.default_value 'default'
  # c.flag :f
  c.action do |global_options,options,args|



    if args.size() != 0
      args.each do | package |
        package_address_split = package.split('/')
        unless package_address_split.size == 2
          help_now! "Bad package address: '#{package}'"
        end
        @pkgr.installPackage(package_address_split[0], package_address_split[1])
      end
    else
      @pkgr.installAllPackages
    end

  end
end

desc 'Uninstalls an application'
arg_name '<username/repository>'
command :uninstall do |c|
  c.action do |global_options,options,args|
    if args.size() != 0
      args.each do | package |
        package_address_split = package.split('/')
        unless package_address_split.size == 2
          help_now! "Bad package address: '#{package}'"
        end
        @pkgr.uninstallPackage(package_address_split[0], package_address_split[1])
      end
    else
      raise "No package specified"
    end
  end
end

desc 'Removes all installed packages'
arg_name ''
command :clean do |c|
  c.action do |global_options,options,args|
    @pkgr.removePackageDirectory
  end
end

pre do |global,command,options,args|

  @pkgr = SatPkgr::SatPkgr.new(Dir.pwd)

  true

end

# post do |global,command,options,args|
# end
# on_error do |exception|
#   # Error logic here
#   # return false to skip default error handling
#   true
# end

exit run(ARGV)
